- id: awake_mode_start
  alias: "Starting Awake mode"
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: "Awake"
  action:
    - service: input_boolean.turn_on
      entity_id: group.all_light_automations
    - condition: state
      entity_id: input_boolean.guests
      state: "off"
    - service: input_boolean.turn_on
      entity_id: input_boolean.living_room_should_illuminate
    - service: light.turn_on
      data:
        entity_id:
          - light.color_light_1 # Joulukuusi

- id: asleep_mode_start
  alias: "Starting Asleep mode"
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: "Asleep"
  action:
    - service: light.turn_on
      data:
        entity_id: 
         - light.markuksen_yopoyta
         - light.veeran_yopoyta
        kelvin: 2700
        brightness: 75
    - service: light.turn_off
      data:
        entity_id:
          - light.makuuhuoneen_yleisvalot
          - light.koristevalot
        transition: 10
    - condition: state
      entity_id: input_boolean.guests
      state: "off"
    - service: input_boolean.turn_off
      entity_id: input_boolean.living_room_should_illuminate

- id: away_mode_lights_turn_off
  alias: "Turn lights off on away mode"
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: "Away"
  action:
    - service: light.turn_off
      data:
        entity_id: group.all_interior_lights
    - service: input_boolean.turn_off
      entity_id: input_boolean.living_room_should_illuminate

- id: living_room_should_illuminate_when_returning_from_special_states
  alias: "Living room should illuminate when returning from special states"
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: "Awake"
      from: "Emergency"
    - platform: state
      entity_id: input_select.home_mode
      to: "Awake"
      from: "Away"
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.living_room_should_illuminate

- id: party_mode_start_lights
  alias: "Starting Party mode lights"
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: "Party"
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.living_room_light_automations
    - service: input_boolean.turn_off
      entity_id: input_boolean.bedroom_light_automations
    - service: light.turn_on
      data:
        entity_id: 
          - light.oh_katto_sisempi
          - light.hue_ambiance_lamp_1_3
        brightness: 168
        color_name: "yellow"
    - service: light.turn_on
      data:
        entity_id: 
          - light.oh_lattiavalaisin
          - light.living_room_shelf_color_1
          - light.oh_valonauhat
          - light.master_bedroom_ceiling_1
        brightness: 125
        effect: "random"

- id: living_room_auto_brightness_set_ceiling
  alias: "Olohuoneen kattovalojen valoautomatiikka"
  trigger:
    - platform: state
      entity_id: input_number.living_room_light_auto_brightness
    - platform: state
      entity_id: input_number.living_room_light_default_kelvin
    - platform: state
      entity_id: input_boolean.living_room_should_illuminate
    - platform: state
      entity_id: input_boolean.living_room_light_automations
    - platform: time_pattern
      minutes: "/2"
  condition:
    - condition: state
      entity_id: input_boolean.living_room_light_automations
      state: "on"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.living_room_should_illuminate
              state: "on"
          sequence:
            - service: light.turn_on
              data_template:
                entity_id: light.olohuoneen_yleisvalot
                brightness: "{{ states('input_number.living_room_light_auto_brightness') | int }}"
                kelvin: "{{ states('input_number.living_room_light_default_kelvin') | int }}"
                transition: 10
            - service: light.turn_on
              data_template:
                entity_id: light.koristevalot
                brightness: "{{ (states('input_number.living_room_light_auto_brightness') | int) / 3 | int }}"
                kelvin: "{{ states('input_number.living_room_light_default_kelvin') | int }}"
                transition: 10
            - service: light.turn_on
              data_template:
                entity_id: light.oh_valonauhat
                brightness: "{{ (states('input_number.living_room_light_auto_brightness') | int) / 3 | int }}"
                kelvin: "{{ states('input_number.living_room_light_default_kelvin') | int }}"
                transition: 10
        - conditions:
            - condition: state
              entity_id: input_boolean.living_room_should_illuminate
              state: "off"
          sequence:
            - service: light.turn_off
              data:
                entity_id: light.olohuoneen_yleisvalot
                transition: 10
            - service: light.turn_off
              data:
                entity_id: light.koristevalot
                transition: 10
            - service: light.turn_off
              data:
                entity_id: light.oh_valonauhat
                transition: 10

- id: living_room_should_illuminate_determination_when_guests
  alias: "Olohuoneen kattovalojen sytytyskriteerit kun vieraita"
  trigger:
    - platform: state
      entity_id: light.olohuoneen_yleisvalot
  condition:
    - condition: state
      entity_id: input_boolean.guests
      state: "on"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: light.olohuoneen_yleisvalot
              state: "off"
          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.living_room_should_illuminate
        - conditions:
            - condition: state
              entity_id: light.olohuoneen_yleisvalot
              state: "on"
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.living_room_should_illuminate

- id: living_room_light_brightness_determination
  alias: "Olohuoneen valaistuksen kirkkauden automaattisäätö"
  trigger:
    - platform: time_pattern
      seconds: "/20"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: light.olohuoneen_yleisvalot
        state: "on"
        for: "00:00:15"
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: sensor.living_room_brightness_difference
            below: -0.8
          - condition: numeric_state
            entity_id: sensor.living_room_brightness_difference
            above: 0.8
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.living_room_light_auto_brightness
        value: >
          {% set current = states('input_number.living_room_light_auto_brightness') | float %}
          {% set change = states('sensor.living_room_brightness_needed_change') | float %}
          {% set new_val = ( current + change ) | round(0, 'ceil') %}
          {% if new_val > 255 %}
            255
          {% elif new_val < 5 %}
            5
          {% else %}
            {{ new_val }}
          {% endif %}

- id: living_room_auto_brightness_default_set
  alias: "Olohuoneen yleisvalojen kirkkauden oletusasetus kun pois päältä"
  trigger:
    - platform: time_pattern
      minutes: "/5"
  condition:
    - condition: state
      entity_id: light.olohuoneen_yleisvalot
      state: "off"
      for:
        minutes: 15
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.living_room_light_auto_brightness
        value: "{{ states('input_number.living_room_light_default_brightness') | int }}"

- id: bedroom_auto_brightness_set_ceiling
  alias: "Makuuhuoneen kattovalojen valoautomatiikka"
  trigger:
    - platform: state
      entity_id: input_number.bedroom_light_default_brightness
    - platform: state
      entity_id: input_number.bedroom_light_default_kelvin
  condition:
    - condition: state
      entity_id: input_boolean.bedroom_light_automations
      state: "on"
    - condition: state
      entity_id: light.makuuhuoneen_yleisvalot
      state: "on"
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.makuuhuoneen_yleisvalot
        brightness: "{{ states('input_number.bedroom_light_default_brightness') | int }}"
        kelvin: "{{ states('input_number.bedroom_light_default_kelvin') | int }}"
        transition: 60

- id: bedroom_light_automations_back_on
  alias: "Makuuhuoneen kattovalojen säätö kun palataan automatiikalle"
  trigger:
    - platform: state
      entity_id: input_boolean.bedroom_light_automations
      to: "on"
  condition:
    - condition: state
      entity_id: light.makuuhuoneen_yleisvalot
      state: "on"
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.makuuhuoneen_yleisvalot
        brightness: "{{ states('input_number.bedroom_light_default_brightness') | int }}"
        kelvin: "{{ states('input_number.bedroom_light_default_kelvin') | int }}"
        transition: 5

- id: bedroom_auto_brightness_set_ceiling_on_start
  alias: "Makuuhuoneen kattovalojen käynnistyksen valoautomatiikka"
  trigger:
    - platform: state
      entity_id: light.makuuhuoneen_yleisvalot
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.bedroom_light_automations
      state: "on"
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.makuuhuoneen_yleisvalot
        brightness: "{{ states('input_number.bedroom_light_default_brightness') | int }}"
        kelvin: "{{ states('input_number.bedroom_light_default_kelvin') | int }}"

- id: hallway_light_autostart_by_motion
  alias: "Eteisen valojen liiketunnistus"
  trigger:
    - platform: state
      entity_id: group.all_hallway_motion
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.hallway_should_illuminate
      state: "on"
    - condition: state
      entity_id: input_boolean.hallway_light_automations
      state: "on"
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.eteisen_yleisvalot
        brightness: "{{ states('input_number.hallway_light_default_brightness') | int }}"
        kelvin: "{{ states('input_number.hallway_light_default_kelvin') | int }}"
    - service: timer.start
      data_template:
        entity_id: timer.hallway_motion_timeout
        duration: "00:{{ states('input_number.hallway_light_turnoff_time') | int}}:00"

- id: kitchen_light_autostart_by_motion
  alias: "Keittiön valojen liiketunnistus"
  trigger:
    - platform: state
      entity_id: group.all_kitchen_motion
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.kitchen_should_illuminate
      state: "on"
    - condition: state
      entity_id: input_boolean.kitchen_light_automations
      state: "on"
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.keittio
        brightness: "{{ states('input_number.kitchen_light_default_brightness') | int }}"
        kelvin: "{{ states('input_number.kitchen_light_default_kelvin') | int }}"
    - service: timer.start
      data_template:
        entity_id: timer.kitchen_motion_timeout
        duration: "00:{{ states('input_number.kitchen_light_turnoff_time') | int}}:00"

- id: toilet_light_autostart_by_motion
  alias: "Pesuhuoneen valojen liiketunnistus"
  trigger:
    - platform: state
      entity_id: group.all_toilet_motion
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.toilet_should_illuminate
      state: "on"
    - condition: state
      entity_id: input_boolean.toilet_light_automations
      state: "on"
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.pesuhuone
        brightness: "{{ states('input_number.toilet_light_default_brightness') | int }}"
        kelvin: "{{ states('input_number.toilet_light_default_kelvin') | int }}"
    - service: timer.start
      data_template:
        entity_id: timer.toilet_motion_timeout
        duration: "00:{{ states('input_number.toilet_light_turnoff_time') | int}}:00"

- id: hallway_light_auto_off
  alias: "Eteisen valojen automaattisammutus"
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.hallway_motion_timeout
  condition:
    - condition: state
      entity_id: group.all_hallway_motion
      state: "off"
    - condition: state
      entity_id: input_boolean.hallway_light_automations
      state: "on"
  action:
    - service: light.turn_off
      entity_id: light.eteisen_yleisvalot

- id: kitchen_light_auto_off
  alias: "Keittiön valojen automaattisammutus"
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.kitchen_motion_timeout
  condition:
    - condition: state
      entity_id: group.all_kitchen_motion
      state: "off"
    - condition: state
      entity_id: input_boolean.kitchen_light_automations
      state: "on"
  action:
    - service: light.turn_off
      entity_id: light.keittio

- id: toilet_light_auto_off
  alias: "Pesuhuoneen valojen automaattisammutus"
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.toilet_motion_timeout
  condition:
    - condition: state
      entity_id: group.all_toilet_motion
      state: "off"
    - condition: state
      entity_id: input_boolean.toilet_light_automations
      state: "on"
  action:
    - service: light.turn_off
      entity_id: light.pesuhuone

- id: hallway_light_timer_restart
  alias: "Eteisen valojen ajastuksen uudelleenkäynnistys"
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.hallway_motion_timeout
  condition:
    - condition: state
      entity_id: group.all_hallway_motion
      state: "on"
  action:
    - service: timer.start
      data_template:
        entity_id: timer.hallway_motion_timeout
        duration: "00:{{ states('input_number.hallway_light_turnoff_time') | int}}:00"

- id: kitchen_light_timer_restart
  alias: "Keittiön valojen ajastuksen uudelleenkäynnistys"
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.kitchen_motion_timeout
  condition:
    - condition: state
      entity_id: group.all_kitchen_motion
      state: "on"
  action:
    - service: timer.start
      data_template:
        entity_id: timer.kitchen_motion_timeout
        duration: "00:{{ states('input_number.kitchen_light_turnoff_time') | int}}:00"

- id: toilet_light_timer_restart
  alias: "Pesuhuoneen valojen ajastuksen uudelleenkäynnistys"
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.toilet_motion_timeout
  condition:
    - condition: state
      entity_id: group.all_toilet_motion
      state: "on"
  action:
    - service: timer.start
      data_template:
        entity_id: timer.toilet_motion_timeout
        duration: "00:{{ states('input_number.toilet_light_turnoff_time') | int}}:00"

- id: circadian_rhythm_setting_changes
  alias: "Valaistuksen asetusten muutokset kellonajan mukaan"
  trigger:
    - platform: time_pattern
      minutes: "/5"
  action:
    - service: python_script.circadian_rhythm

- id: light_hallway_illumination_criteria
  alias: "Eteisen valaistuksen käynnistyskriteerit"
  trigger:
    - platform: time_pattern
      minutes: "/1"
    - platform: numeric_state
      entity_id: sensor.eteisen_liiketunnistin_light_level
      below: 30
    - platform: numeric_state
      entity_id: sensor.eteisen_liiketunnistin_light_level
      above: 40
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.eteisen_liiketunnistin_light_level
              below: 30
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.hallway_should_illuminate
        - conditions:
            - condition: numeric_state
              entity_id: sensor.eteisen_liiketunnistin_light_level
              above: 40
            - condition: state
              entity_id: light.eteisen_yleisvalot
              state: "off"
              for:
                minutes: 1
          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.hallway_should_illuminate

- id: light_kitchen_illumination_criteria
  alias: "Keittiön valaistuksen käynnistyskriteerit"
  trigger:
    - platform: time_pattern
      minutes: "/1"
    - platform: numeric_state
      entity_id: sensor.kitchen_sensor_light_level
      below: 30
    - platform: numeric_state
      entity_id: sensor.kitchen_sensor_light_level
      above: 40
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.kitchen_sensor_light_level
              below: 30
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.kitchen_should_illuminate
        - conditions:
            - condition: numeric_state
              entity_id: sensor.kitchen_sensor_light_level
              above: 40
            - condition: state
              entity_id: light.keittio
              state: "off"
              for:
                minutes: 1
          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.kitchen_should_illuminate

- id: light_toilet_illumination_criteria
  alias: "Pesuhuoneen valaistuksen käynnistyskriteerit"
  trigger:
    - platform: time_pattern
      minutes: "/1"
    - platform: numeric_state
      entity_id: sensor.toilet_sensor_light_level
      below: 30
    - platform: numeric_state
      entity_id: sensor.toilet_sensor_light_level
      above: 40
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.toilet_sensor_light_level
              below: 30
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.toilet_should_illuminate
        - conditions:
            - condition: numeric_state
              entity_id: sensor.toilet_sensor_light_level
              above: 40
            - condition: state
              entity_id: light.pesuhuone
              state: "off"
              for:
                minutes: 1
          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.toilet_should_illuminate

- id: cloakroom_light_turn_on
  alias: "Vaatehuoneen valaistuksen käynnistys"
  trigger:
    - platform: state
      entity_id: switch.cloakroom_motion
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.cloakroom_light_automations
      state: "on"
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.vaatehuone
        brightness: 255
        kelvin: 5000

- id: cloakroom_light_turn_off
  alias: "Vaatehuoneen valaistuksen sammutus"
  trigger:
    - platform: state
      entity_id: switch.cloakroom_motion
      to: "off"
      for: "00:01:00"
    - platform: state
      entity_id: switch.cloakroom_motion
      to: "on"
      for: "00:15:00"
  condition:
    - condition: state
      entity_id: input_boolean.cloakroom_light_automations
      state: "on"
  action:
    - service: light.turn_off
      entity_id: light.vaatehuone
    - service: switch.turn_off
      entity_id: switch.cloakroom_motion
