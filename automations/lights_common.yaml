# Common light automations

- id: actual_light_control
  alias: "Valaistuksen fyysisen tilan muutos"
  mode: queued
  max: 20
  trigger:
    - platform: state
      entity_id: input_boolean.light_result_state_living_room
      variables:
        room: living_room
        target_zone: olohuone
    - platform: state
      entity_id: input_boolean.light_result_state_hallway
      variables:
        room: hallway
        target_zone: eteinen
    - platform: state
      entity_id: input_boolean.light_result_state_kitchen
      variables:
        room: kitchen
        target_zone: keittio
    - platform: state
      entity_id: input_boolean.light_result_state_toilet
      variables:
        room: toilet
        target_zone: pesuhuone
    - platform: state
      entity_id: input_boolean.light_result_state_bedroom
      variables:
        room: bedroom
        target_zone: makuuhuone
    - platform: state
      entity_id: input_boolean.light_result_state_office
      variables:
        room: office
        target_zone: tyohuoneen_yleisvalaistus
  condition:
    - condition: state
      entity_id: input_select.home_mode
      state:
        - "Awake"
        - "Away"
        - "Asleep"
  action:
    - choose:
        - conditions:
            - "{{ is_state('input_boolean.light_result_state_'+room, 'off') }}"
          sequence:
            - service: light.turn_off
              target:
                entity_id: "light.{{ target_zone }}"
        - conditions:
            - "{{ is_state('input_boolean.light_result_state_'+room, 'on') }}"
            - condition: state
              entity_id: input_select.home_mode
              state: "Asleep"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: "scene.{{ target_zone }}_yo"
        - conditions:
            - "{{ is_state('input_boolean.light_result_state_'+room, 'on') }}"
            - condition: time
              before: "08:00:00"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: "scene.{{ target_zone }}_aamu"
        - conditions:
            - "{{ is_state('input_boolean.light_result_state_'+room, 'on') }}"
            - condition: time
              before: "20:30:00"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: "scene.{{ target_zone }}_paiva"
      default:
        - service: scene.turn_on
          target:
            entity_id: "scene.{{ target_zone }}_ilta"

- id: turn_off_lights_on_away
  alias: "Valaistuksen sammutus kun Away"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: Away
  action:
    - service: light.turn_off
      target:
        entity_id: all

# TODO: Emergency

- id: light_update_states_on_motion
  alias: "Valoautomatiikan liiketunnistuksen tilojen p채ivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_living_room
      variables:
        room: living_room
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_toilet
      variables:
        room: toilet
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_bedroom
      variables:
        room: bedroom
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_office
      variables:
        room: office
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: "input_boolean.turn_{{ states(trigger.entity_id) }}"
      target:
        entity_id: "input_boolean.light_result_state_{{ room }}"

- id: light_store_turnoff_time_results_awake
  alias: "Valoautomatiikan sammutusaikojen p채ivitys: Awake"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_awake_turnoff_time_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_number.light_auto_awake_turnoff_time_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_number.light_auto_awake_turnoff_time_toilet
      variables:
        room: toilet
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.home_mode', 'Awake') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"

- id: light_store_turnoff_time_results_away
  alias: "Valoautomatiikan sammutusaikojen p채ivitys: Away"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_away_turnoff_time_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_number.light_auto_away_turnoff_time_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_number.light_auto_away_turnoff_time_toilet
      variables:
        room: toilet
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.home_mode', 'Away') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"

- id: light_store_turnoff_time_results_asleep
  alias: "Valoautomatiikan sammutusaikojen p채ivitys: Asleep"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_asleep_turnoff_time_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_number.light_auto_asleep_turnoff_time_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_number.light_auto_asleep_turnoff_time_toilet
      variables:
        room: toilet
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.home_mode', 'Asleep') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"



- id: light_store_results_automation_on_mode_change
  alias: "Valaistuksen moodien muutokset"
  mode: queued
  max: 20
  trigger:
    - platform: state
      entity_id: input_select.light_base_mode_living_room
      variables:
        room: living_room
    - platform: state
      entity_id: input_select.light_base_mode_office
      variables:
        room: office
    - platform: state
      entity_id: input_select.light_base_mode_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_select.light_base_mode_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_select.light_base_mode_toilet
      variables:
        room: toilet
    - platform: state
      entity_id: input_select.light_base_mode_bedroom
      variables:
        room: bedroom
  action:
    - choose:
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Off') }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.home_mode', 'Awake') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_source_motion_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_turnoff_time_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_awake_turnoff_time_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.home_mode', 'Asleep') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_source_motion_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_turnoff_time_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_asleep_turnoff_time_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.home_mode', 'Away') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_source_motion_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_turnoff_time_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_away_turnoff_time_'+room) }}"

- id: light_store_results_on_home_mode_change_to_awake
  alias: "Valaistuksen sammutusaikojen muutokset kun Awake"
  mode: queued
  max: 20
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: 'Awake'
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_living_room"
      data:
        value: "{{ states('input_number.light_auto_awake_turnoff_time_living_room') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_bedroom"
      data:
        value: "{{ states('input_number.light_auto_awake_turnoff_time_bedroom') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_office"
      data:
        value: "{{ states('input_number.light_auto_awake_turnoff_time_office') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_hallway"
      data:
        value: "{{ states('input_number.light_auto_awake_turnoff_time_hallway') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_kitchen"
      data:
        value: "{{ states('input_number.light_auto_awake_turnoff_time_kitchen') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_toilet"
      data:
        value: "{{ states('input_number.light_auto_awake_turnoff_time_toilet') }}"

- id: light_store_results_on_home_mode_change_to_away
  alias: "Valaistuksen sammutusaikojen muutokset kun Away"
  mode: queued
  max: 20
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: 'Away'
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_living_room"
      data:
        value: "{{ states('input_number.light_auto_away_turnoff_time_living_room') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_bedroom"
      data:
        value: "{{ states('input_number.light_auto_away_turnoff_time_bedroom') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_office"
      data:
        value: "{{ states('input_number.light_auto_away_turnoff_time_office') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_hallway"
      data:
        value: "{{ states('input_number.light_auto_away_turnoff_time_hallway') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_kitchen"
      data:
        value: "{{ states('input_number.light_auto_away_turnoff_time_kitchen') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_toilet"
      data:
        value: "{{ states('input_number.light_auto_away_turnoff_time_toilet') }}"

- id: light_store_results_on_home_mode_change_to_asleep
  alias: "Valaistuksen sammutusaikojen muutokset kun Asleep"
  mode: queued
  max: 20
  trigger:
    - platform: state
      entity_id: input_select.home_mode
      to: 'Asleep'
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_living_room"
      data:
        value: "{{ states('input_number.light_auto_asleep_turnoff_time_living_room') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_bedroom"
      data:
        value: "{{ states('input_number.light_auto_asleep_turnoff_time_bedroom') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_office"
      data:
        value: "{{ states('input_number.light_auto_asleep_turnoff_time_office') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_hallway"
      data:
        value: "{{ states('input_number.light_auto_asleep_turnoff_time_hallway') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_kitchen"
      data:
        value: "{{ states('input_number.light_auto_asleep_turnoff_time_kitchen') }}"
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_toilet"
      data:
        value: "{{ states('input_number.light_auto_asleep_turnoff_time_toilet') }}"
