# Common light automations

- id: circadian_rhythm_setting_changes
  alias: "Valaistuksen asetusten muutokset kellonajan mukaan"
  trigger:
    - platform: time_pattern
      minutes: "/5"
  action:
    - service: python_script.circadian_rhythm

- id: light_auto_home_mode_selector_follow_home_mode
  alias: "Light auto-home-mode-selectors to follow Home Mode"
  mode: restart
  trigger:
    - platform: state
      entity_id: input_select.home_mode
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_living_room
      data:
        option: "{{ trigger.to_state.state }}"
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_hallway
      data:
        option: "{{ trigger.to_state.state }}"
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_kitchen
      data:
        option: "{{ trigger.to_state.state }}"
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_toilet
      data:
        option: "{{ trigger.to_state.state }}"
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_bedroom
      data:
        option: "{{ trigger.to_state.state }}"
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_living_room_decorative
      data:
        option: "{{ trigger.to_state.state }}"
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_light_strips
      data:
        option: "{{ trigger.to_state.state }}"
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_office
      data:
        option: "{{ trigger.to_state.state }}"

- id: light_update_states_on_motion
  alias: "Valoautomatiikan liiketunnistuksen tilojen päivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_living_room
      variables:
        room: living_room
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_toilet
      variables:
        room: toilet
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_bedroom
      variables:
        room: bedroom
  action:
    - repeat:
        for_each:
          - "awake"
          - "asleep"
          - "away"
          - "emergency"
        sequence:
          - if:
              - alias: "If we want to follow motion detections"
                condition: template
                value_template: "{{ is_state('input_boolean.light_auto_'+repeat.item+'_follow_motion_'+room, 'on') }}"
            then:
              - service_template: "input_boolean.turn_{{ states(trigger.entity_id) }}"
                target:
                  entity_id: "input_boolean.light_auto_{{ repeat.item }}_state_{{ room }}"

- id: light_store_state_results
  alias: "Valoautomatiikan tilojen päivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_living_room
      variables:
        room: living_room
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_living_room
      variables:
        room: living_room
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_living_room
      variables:
        room: living_room
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_living_room
      variables:
        room: living_room
        home_mode: Emergency
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_light_strips
      variables:
        room: light_strips
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_light_strips
      variables:
        room: light_strips
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_light_strips
      variables:
        room: light_strips
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_light_strips
      variables:
        room: light_strips
        home_mode: Emergency
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_living_room_decorative
      variables:
        room: living_room_decorative
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_living_room_decorative
      variables:
        room: living_room_decorative
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_living_room_decorative
      variables:
        room: living_room_decorative
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_living_room_decorative
      variables:
        room: living_room_decorative
        home_mode: Emergency
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_office
      variables:
        room: office
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_office
      variables:
        room: office
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_office
      variables:
        room: office
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_office
      variables:
        room: office
        home_mode: Emergency
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_hallway
      variables:
        room: hallway
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_hallway
      variables:
        room: hallway
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_hallway
      variables:
        room: hallway
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_hallway
      variables:
        room: hallway
        home_mode: Emergency
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_kitchen
      variables:
        room: kitchen
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_kitchen
      variables:
        room: kitchen
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_kitchen
      variables:
        room: kitchen
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_kitchen
      variables:
        room: kitchen
        home_mode: Emergency
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_toilet
      variables:
        room: toilet
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_toilet
      variables:
        room: toilet
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_toilet
      variables:
        room: toilet
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_toilet
      variables:
        room: toilet
        home_mode: Emergency
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_bedroom
      variables:
        room: bedroom
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_bedroom
      variables:
        room: bedroom
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_bedroom
      variables:
        room: bedroom
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_bedroom
      variables:
        room: bedroom
        home_mode: Emergency
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_auto_home_mode_'+room, home_mode) }}"
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: "input_boolean.turn_{{ states(trigger.entity_id) }}"
      target:
        entity_id: "input_boolean.light_result_state_{{ room }}"

- id: light_store_brightness_results
  alias: "Valoautomatiikan kirkkauksien päivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_awake_brightness_living_room
      variables:
        room: living_room
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_brightness_living_room
      variables:
        room: living_room
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_brightness_living_room
      variables:
        room: living_room
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_brightness_living_room
      variables:
        room: living_room
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_brightness_hallway
      variables:
        room: hallway
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_brightness_hallway
      variables:
        room: hallway
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_brightness_hallway
      variables:
        room: hallway
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_brightness_hallway
      variables:
        room: hallway
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_brightness_kitchen
      variables:
        room: kitchen
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_brightness_kitchen
      variables:
        room: kitchen
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_brightness_kitchen
      variables:
        room: kitchen
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_brightness_kitchen
      variables:
        room: kitchen
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_brightness_toilet
      variables:
        room: toilet
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_brightness_toilet
      variables:
        room: toilet
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_brightness_toilet
      variables:
        room: toilet
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_brightness_toilet
      variables:
        room: toilet
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_brightness_bedroom
      variables:
        room: bedroom
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_brightness_bedroom
      variables:
        room: bedroom
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_brightness_bedroom
      variables:
        room: bedroom
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_brightness_bedroom
      variables:
        room: bedroom
        home_mode: Emergency
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_auto_home_mode_'+room, home_mode) }}"
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_brightness_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"

- id: light_store_kelvin_results
  alias: "Valoautomatiikan kelvinien päivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_awake_kelvin_living_room
      variables:
        room: living_room
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_kelvin_living_room
      variables:
        room: living_room
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_kelvin_living_room
      variables:
        room: living_room
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_kelvin_living_room
      variables:
        room: living_room
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_kelvin_hallway
      variables:
        room: hallway
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_kelvin_hallway
      variables:
        room: hallway
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_kelvin_hallway
      variables:
        room: hallway
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_kelvin_hallway
      variables:
        room: hallway
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_kelvin_kitchen
      variables:
        room: kitchen
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_kelvin_kitchen
      variables:
        room: kitchen
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_kelvin_kitchen
      variables:
        room: kitchen
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_kelvin_kitchen
      variables:
        room: kitchen
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_kelvin_toilet
      variables:
        room: toilet
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_kelvin_toilet
      variables:
        room: toilet
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_kelvin_toilet
      variables:
        room: toilet
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_kelvin_toilet
      variables:
        room: toilet
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_kelvin_bedroom
      variables:
        room: bedroom
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_kelvin_bedroom
      variables:
        room: bedroom
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_kelvin_bedroom
      variables:
        room: bedroom
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_kelvin_bedroom
      variables:
        room: bedroom
        home_mode: Emergency
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_auto_home_mode_'+room, home_mode) }}"
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_kelvin_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"

- id: light_store_turnoff_time_results
  alias: "Valoautomatiikan sammutusaikojen päivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_awake_turnoff_time_hallway
      variables:
        room: hallway
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_turnoff_time_hallway
      variables:
        room: hallway
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_turnoff_time_hallway
      variables:
        room: hallway
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_turnoff_time_hallway
      variables:
        room: hallway
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_turnoff_time_kitchen
      variables:
        room: kitchen
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_turnoff_time_kitchen
      variables:
        room: kitchen
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_turnoff_time_kitchen
      variables:
        room: kitchen
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_turnoff_time_kitchen
      variables:
        room: kitchen
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_turnoff_time_toilet
      variables:
        room: toilet
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_turnoff_time_toilet
      variables:
        room: toilet
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_turnoff_time_toilet
      variables:
        room: toilet
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_turnoff_time_toilet
      variables:
        room: toilet
        home_mode: Emergency
    - platform: state
      entity_id: input_number.light_auto_awake_turnoff_time_bedroom
      variables:
        room: bedroom
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_turnoff_time_bedroom
      variables:
        room: bedroom
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_turnoff_time_bedroom
      variables:
        room: bedroom
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_turnoff_time_bedroom
      variables:
        room: bedroom
        home_mode: Emergency
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_auto_home_mode_'+room, home_mode) }}"
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_turnoff_time_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"

- id: light_store_results_automation_on_mode_change
  alias: "Valaistuksen moodien muutokset"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_select.light_base_mode_living_room
      variables:
        room: living_room
    - platform: state
      entity_id: input_select.light_auto_home_mode_living_room
      variables:
        room: living_room
    - platform: state
      entity_id: input_select.light_base_mode_living_room_decorative
      variables:
        room: living_room_decorative
    - platform: state
      entity_id: input_select.light_auto_home_mode_living_room_decorative
      variables:
        room: living_room_decorative
    - platform: state
      entity_id: input_select.light_base_mode_light_strips
      variables:
        room: light_strips
    - platform: state
      entity_id: input_select.light_auto_home_mode_light_strips
      variables:
        room: light_strips
    - platform: state
      entity_id: input_select.light_base_mode_office
      variables:
        room: office
    - platform: state
      entity_id: input_select.light_auto_home_mode_office
      variables:
        room: office
    - platform: state
      entity_id: input_select.light_base_mode_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_select.light_auto_home_mode_hallway
      variables:
        room: hallway
    - platform: state
      entity_id: input_select.light_base_mode_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_select.light_auto_home_mode_kitchen
      variables:
        room: kitchen
    - platform: state
      entity_id: input_select.light_base_mode_toilet
      variables:
        room: toilet
    - platform: state
      entity_id: input_select.light_auto_home_mode_toilet
      variables:
        room: toilet
    - platform: state
      entity_id: input_select.light_base_mode_bedroom
      variables:
        room: bedroom
    - platform: state
      entity_id: input_select.light_auto_home_mode_bedroom
      variables:
        room: bedroom
  action:
    - choose:
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Off') }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Awake') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_awake_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_awake_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_awake_kelvin_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_turnoff_time_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_awake_turnoff_time_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Asleep') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_asleep_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_asleep_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_asleep_kelvin_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_turnoff_time_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_asleep_turnoff_time_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Away') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_away_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_away_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_away_kelvin_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_turnoff_time_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_away_turnoff_time_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Emergency') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_emergency_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_emergency_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_emergency_kelvin_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_turnoff_time_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_emergency_turnoff_time_'+room) }}"


