# Common light automations

- id: circadian_rhythm_setting_changes
  alias: "Valaistuksen asetusten muutokset kellonajan mukaan"
  trigger:
    - platform: time_pattern
      minutes: "/5"
  action:
    - service: python_script.circadian_rhythm

- id: light_auto_home_mode_selector_follow_home_mode
  alias: "Light auto-home-mode-selectors to follow Home Mode"
  mode: restart
  trigger:
    - platform: state
      entity_id: input_select.home_mode
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.light_auto_home_mode_living_room
      data:
        option: "{{ trigger.to_state.state }}"

- id: light_update_states_on_motion
  alias: "Valoautomatiikan liiketunnistuksen tilojen p채ivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_boolean.light_auto_source_motion_state_living_room
      variables:
        room: living_room
  action:
    - repeat:
        for_each:
          - "awake"
          - "asleep"
          - "away"
          - "emergency"
        sequence:
          - if:
              - alias: "If we want to follow motion detections"
                condition: state
                entity_id: "input_boolean.light_auto_{{ repeat.item }}_follow_motion_{{ room }}"
                state: "on"
            then:
              - service_template: "input_boolean.turn_{{ states(trigger.entity_id) }}"
                target:
                  entity_id: "input_boolean.light_auto_{{ repeat.item }}_state_{{ room }}"

- id: light_store_state_results
  alias: "Valoautomatiikan tilojen p채ivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_boolean.light_auto_awake_state_living_room
      variables:
        room: living_room
        home_mode: Awake
    - platform: state
      entity_id: input_boolean.light_auto_asleep_state_living_room
      variables:
        room: living_room
        home_mode: Asleep
    - platform: state
      entity_id: input_boolean.light_auto_away_state_living_room
      variables:
        room: living_room
        home_mode: Away
    - platform: state
      entity_id: input_boolean.light_auto_emergency_state_living_room
      variables:
        room: living_room
        home_mode: Emergency
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_auto_home_mode_'+room, home_mode) }}"
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: "input_boolean.turn_{{ states(trigger.entity_id) }}"
      target:
        entity_id: "input_boolean.light_result_state_{{ room }}"

- id: light_store_brightness_results
  alias: "Valoautomatiikan kirkkauksien p채ivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_awake_brightness_living_room
      variables:
        room: living_room
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_brightness_living_room
      variables:
        room: living_room
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_brightness_living_room
      variables:
        room: living_room
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_brightness_living_room
      variables:
        room: living_room
        home_mode: Emergency
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_auto_home_mode_'+room, home_mode) }}"
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_brightness_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"

- id: light_store_kelvin_results
  alias: "Valoautomatiikan kelvinien p채ivitys"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_number.light_auto_awake_kelvin_living_room
      variables:
        room: living_room
        home_mode: Awake
    - platform: state
      entity_id: input_number.light_auto_asleep_kelvin_living_room
      variables:
        room: living_room
        home_mode: Asleep
    - platform: state
      entity_id: input_number.light_auto_away_kelvin_living_room
      variables:
        room: living_room
        home_mode: Away
    - platform: state
      entity_id: input_number.light_auto_emergency_kelvin_living_room
      variables:
        room: living_room
        home_mode: Emergency
  condition:
    - condition: template
      value_template: "{{ is_state('input_select.light_auto_home_mode_'+room, home_mode) }}"
    - condition: template
      value_template: "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
  action:
    - service_template: input_number.set_value
      target:
        entity_id: "input_number.light_result_kelvin_{{ room }}"
      data:
        value: "{{ trigger.to_state.state }}"

- id: light_store_results_automation_on_mode_change
  alias: "Valaistuksen moodien muutokset"
  mode: queued
  trigger:
    - platform: state
      entity_id: input_select.light_base_mode_living_room
      variables:
        room: living_room
    - platform: state
      entity_id: input_select.light_auto_home_mode_living_room
      variables:
        room: living_room
  action:
    - choose:
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Off') }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Awake') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_awake_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_awake_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_awake_kelvin_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Asleep') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_asleep_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_asleep_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_asleep_kelvin_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Away') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_away_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_away_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_away_kelvin_'+room) }}"
        - conditions:
            - "{{ is_state('input_select.light_base_mode_'+room, 'Automatic') }}"
            - "{{ is_state('input_select.light_auto_home_mode_'+room, 'Emergency') }}"
          sequence:
            - service_template: "input_boolean.turn_{{ states('input_boolean.light_auto_emergency_state_'+room) }}"
              target:
                entity_id: "input_boolean.light_result_state_{{ room }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_brightness_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_emergency_brightness_'+room) }}"
            - service_template: input_number.set_value
              target:
                entity_id: "input_number.light_result_kelvin_{{ room }}"
              data:
                value: "{{ states('input_number.light_auto_emergency_kelvin_'+room) }}"


